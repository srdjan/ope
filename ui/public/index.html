<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Online Prompt Enhancer</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f6f6f8;
        --card: #ffffff;
        --border: #d7d7e0;
        --text: #1c1c1f;
        --muted: #5a5a62;
        --accent: #2f6fed;
        --accent-hover: #2154c3;
        --accent-2: #9c56ff;
        --error: #d63d3d;
        --font-body:
          "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        --radius: 16px;
        --shadow: 0 12px 32px rgba(34, 43, 68, 0.12);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0b10;
          --card: #12121b;
          --border: #2a2a38;
          --text: #f4f4f7;
          --muted: rgba(244, 244, 247, 0.68);
          --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background:
          radial-gradient(
            900px circle at 20% -15%,
            rgba(47, 111, 237, 0.22),
            transparent 55%
          ),
          radial-gradient(
            900px circle at 115% 10%,
            rgba(156, 86, 255, 0.14),
            transparent 50%
          ),
          var(--bg);
        font-family: var(--font-body);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 16px 12px 24px;
      }

      main {
        width: min(960px, 100%);
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 14px;
        padding: 16px 18px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .brand {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      header h1 {
        margin: 0;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .workspace {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        min-height: 0;
      }

      section.panel {
        padding: 18px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      @media (min-width: 980px) {
        body {
          height: 100vh;
          overflow: hidden;
          padding: 18px;
        }

        main {
          height: 100%;
          width: min(1240px, 100%);
        }

        .workspace {
          grid-template-columns: minmax(360px, 420px) minmax(0, 1fr);
          flex: 1 1 auto;
          min-height: 0;
        }

        #input-panel,
        #output-panel {
          min-height: 0;
          overflow: hidden;
        }
      }

      label {
        display: block;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 6px;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .label-row label {
        margin: 0;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .field-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (min-width: 920px) {
        .field-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        font: inherit;
        font-size: 0.92rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.85);
        color: var(--text);
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.16);
      }

      .hint {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 6px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
        flex-wrap: wrap;
      }

      .tab {
        appearance: none;
        border: 1px solid transparent;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-weight: 500;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition:
          background 120ms ease,
          color 120ms ease,
          border 120ms ease;
      }

      .tab:hover {
        background: rgba(47, 111, 237, 0.08);
        color: var(--text);
      }

      .tab[aria-selected="true"] {
        color: var(--text);
        border-color: rgba(47, 111, 237, 0.35);
        background: rgba(47, 111, 237, 0.12);
      }

      .tab:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.18);
      }

      .tabpanel[hidden] {
        display: none;
      }

      textarea {
        width: 100%;
        min-height: 140px;
        padding: 12px 14px;
        font-family:
          "JetBrains Mono", "SFMono-Regular", ui-monospace, Menlo, Consolas,
          "Liberation Mono", monospace;
        font-size: 0.9rem;
        line-height: 1.45;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        resize: vertical;
        background: rgba(255, 255, 255, 0.8);
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      textarea.prompt-input {
        font-family: var(--font-body);
        font-size: 0.95rem;
        line-height: 1.55;
        background: rgba(255, 255, 255, 0.86);
      }

      input[type="text"],
      input[type="search"],
      input[type="url"] {
        width: 100%;
        padding: 10px 12px;
        font-family: var(--font-body);
        font-size: 0.9rem;
        line-height: 1.4;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.95);
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.16);
      }

      textarea[readonly] {
        background: rgba(248, 248, 252, 0.7);
        color: var(--text);
      }

      @media (prefers-color-scheme: dark) {
        select,
        input[type="text"],
        input[type="search"],
        input[type="url"],
        textarea {
          background: rgba(255, 255, 255, 0.04);
        }

        textarea[readonly] {
          background: rgba(255, 255, 255, 0.03);
        }
      }

      textarea::placeholder {
        color: rgba(92, 95, 109, 0.68);
      }

      input::placeholder {
        color: rgba(92, 95, 109, 0.68);
      }

      .form-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.01em;
        transition:
          transform 120ms ease,
          box-shadow 120ms ease,
          background 120ms ease;
      }

      button[type="submit"] {
        background: var(--accent);
        color: white;
        box-shadow: 0 10px 24px rgba(47, 111, 237, 0.22);
      }

      button[type="submit"]:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(47, 111, 237, 0.28);
      }

      button[type="submit"][disabled],
      button[type="submit"][data-loading="true"] {
        background: var(--accent-hover);
        opacity: 0.65;
        cursor: progress;
        transform: none;
        box-shadow: none;
      }

      button[type="submit"][data-loading="true"]::after {
        content: "";
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: white;
        margin-left: 12px;
        animation: spinner 700ms linear infinite;
        vertical-align: middle;
      }

      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      button.copy {
        background: rgba(47, 111, 237, 0.1);
        color: var(--accent);
        padding: 0.55rem 1.2rem;
        border-radius: 12px;
        box-shadow: none;
      }

      button.copy:hover {
        background: rgba(47, 111, 237, 0.16);
      }

      button.copy:disabled {
        color: rgba(47, 111, 237, 0.45);
        background: rgba(47, 111, 237, 0.08);
        cursor: not-allowed;
      }

      .status {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .feedback {
        font-size: 0.8rem;
        color: var(--muted);
        min-height: 1em;
      }

      .error {
        background: rgba(214, 61, 61, 0.08);
        border: 1px solid rgba(214, 61, 61, 0.32);
        color: var(--error);
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
      }

      #error-message {
        max-height: 22vh;
        overflow: auto;
      }

      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .panel-head label {
        margin: 0;
      }

      .panel-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      button.ghost {
        background: transparent;
        border: 1px solid rgba(90, 90, 98, 0.25);
        color: var(--text);
        padding: 0.55rem 1.05rem;
        border-radius: 999px;
        box-shadow: none;
        font-weight: 600;
      }

      button.ghost:hover {
        background: rgba(47, 111, 237, 0.08);
        border-color: rgba(47, 111, 237, 0.35);
      }

      button.ghost:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .output-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        min-height: 0;
        flex: 1 1 auto;
      }

      .output-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px 12px 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 0;
        background:
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.65),
            rgba(255, 255, 255, 0.35)
          );
      }

      @media (prefers-color-scheme: dark) {
        .output-card {
          background:
            linear-gradient(
              180deg,
              rgba(255, 255, 255, 0.05),
              rgba(255, 255, 255, 0.02)
            );
        }
      }

      .output-card-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .output-card-title {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .output-card-title .title {
        font-weight: 600;
        letter-spacing: -0.01em;
        margin: 0;
        font-size: 0.92rem;
      }

      .output-card-title .meta {
        color: var(--muted);
        font-size: 0.78rem;
      }

      .output-card textarea {
        flex: 1 1 auto;
        min-height: 0;
        height: 100%;
        resize: none;
        background: rgba(255, 255, 255, 0.65);
      }

      @media (prefers-color-scheme: dark) {
        .output-card textarea {
          background: rgba(255, 255, 255, 0.03);
        }
      }

      @media (min-width: 980px) {
        #enhance-form {
          display: flex;
          flex-direction: column;
          min-height: 0;
          gap: 12px;
        }

        #raw-prompt {
          flex: 1 1 auto;
          min-height: 0;
          resize: none;
        }

        #output-panel {
          display: flex;
          flex-direction: column;
        }

        .output-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          grid-template-rows: repeat(3, minmax(0, 1fr));
        }

        .output-card[data-span="2"] {
          grid-column: 1 / -1;
        }
      }

      @media (max-width: 720px) {
        header,
        section.panel {
          padding: 16px;
        }

        textarea {
          min-height: 130px;
        }

        .form-actions {
          flex-direction: column;
          align-items: flex-start;
        }

        .form-actions button {
          width: 100%;
          text-align: center;
        }

        .label-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .field-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (min-height: 900px) {
        body {
          padding: 32px 16px 64px;
        }

        main {
          gap: 24px;
        }

        header {
          padding: 24px 28px;
        }

        section.panel {
          padding: 28px;
        }

        textarea {
          min-height: 200px;
          padding: 16px 18px;
          font-size: 0.95rem;
          line-height: 1.5;
        }

        button {
          padding: 0.75rem 1.75rem;
          font-size: 0.95rem;
        }

        .status {
          font-size: 0.9rem;
        }

        .feedback {
          font-size: 0.85rem;
        }

        .error {
          padding: 14px 18px;
          font-size: 0.92rem;
        }
      }
    </style>
    <script defer src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script
      defer
      src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"
    ></script>
    <script>
      (() => {
        const enhanceFormId = "enhance-form";
        const promptOutputId = "enhanced-output";
        const signatureOutputId = "signature-output";
        const finalSystemOutputId = "final-system-output";
        const finalUserOutputId = "final-user-output";
        const modelOutputId = "model-output";
        const statusId = "status-text";
        const errorId = "error-message";
        const copyFeedbackId = "copy-feedback";
        const contextSelectId = "context-select";
        const contextHintId = "context-hint";
        const copyAllId = "copy-all";
        const downloadJsonId = "download-json";

        const createState = (overrides = {}) =>
          Object.freeze({
            isLoading: false,
            signatureText: "",
            enhancedPromptText: "",
            finalSystemText: "",
            finalUserText: "",
            modelOutputText: "",
            error: null,
            copyFeedback: "",
            lastPayload: null,
            ...overrides,
          });

        const mergeState = (prev, patch) =>
          createState({ ...prev, ...patch });

        const parseJsonSafe = (raw) => {
          try {
            return raw ? JSON.parse(raw) : null;
          } catch {
            return null;
          }
        };

        const getCompiledPrompts = (payload) => {
          const meta = payload && payload.meta ? payload.meta : null;
          const signature = meta && meta.signature
            ? meta.signature
            : null;
          const compiled = meta && meta.compiled ? meta.compiled : null;
          const source = signature || compiled;
          if (!source) return { system: "", user: "" };
          return {
            system: typeof source.system === "string"
              ? source.system
              : "",
            user: typeof source.user === "string" ? source.user : "",
          };
        };

        const deriveSignatureText = (payload) => {
          // DSPy Signature = IR structure (role, objective, constraints, etc.)
          const ir = payload && payload.meta && payload.meta.ir
            ? payload.meta.ir
            : null;
          if (!ir) return "";

          const lines = [];
          if (ir.role) lines.push(`ROLE: ${ir.role}`);
          if (ir.objective) lines.push(`OBJECTIVE: ${ir.objective}`);
          if (ir.constraints && ir.constraints.length) {
            lines.push(
              `CONSTRAINTS:\n${
                ir.constraints.map((c) => `  • ${c}`).join("\n")
              }`,
            );
          }
          if (ir.style && ir.style.length) {
            lines.push(
              `STYLE:\n${ir.style.map((s) => `  • ${s}`).join("\n")}`,
            );
          }
          if (ir.steps && ir.steps.length) {
            lines.push(
              `STEPS:\n${
                ir.steps.map((s, i) => `  ${i + 1}. ${s}`).join("\n")
              }`,
            );
          }
          if (ir.examples && ir.examples.length) {
            lines.push(
              `EXAMPLES: ${ir.examples.length} few-shot example(s)`,
            );
          }
          if (ir.outputSchema) {
            lines.push(
              `OUTPUT SCHEMA: ${JSON.stringify(ir.outputSchema)}`,
            );
          }
          return lines.join("\n\n");
        };

        const deriveEnhancedPromptText = (payload) => {
          // Enhanced Prompt = the transformed user prompt that will be sent to the model.
          // Prefer extracting the exact prompt used from the compiled user prompt (TASK section),
          // since meta.prompt / meta.enhancement may be display-formatted in demo mode.
          const { user: compiledUser } = getCompiledPrompts(payload);
          if (compiledUser) {
            const taskMatch = compiledUser.match(
              /TASK:\n([\s\S]*?)\n\nOUTPUT:/,
            );
            if (taskMatch && typeof taskMatch[1] === "string") {
              return taskMatch[1];
            }
          }

          const enhanced =
            payload && payload.meta && payload.meta.enhancement &&
              typeof payload.meta.enhancement.enhancedPrompt ===
                "string"
              ? payload.meta.enhancement.enhancedPrompt
              : null;
          if (enhanced && enhanced.length) return enhanced;

          const prompt = payload && payload.meta &&
              typeof payload.meta.prompt === "string"
            ? payload.meta.prompt
            : "";
          return prompt;
        };

        const deriveFinalSystemText = (payload) => {
          return getCompiledPrompts(payload).system;
        };

        const deriveFinalUserText = (payload) => {
          return getCompiledPrompts(payload).user;
        };

        const deriveModelOutputText = (payload) => {
          if (
            payload &&
            payload.output &&
            typeof payload.output.answer === "string"
          ) {
            return payload.output.answer;
          }
          return "";
        };

        const deriveErrorMessage = (payload, status) => {
          if (payload) {
            if (
              typeof payload.detail === "string" &&
              payload.detail.trim().length
            ) {
              return payload.detail.trim();
            }
            if (
              typeof payload.error === "string" &&
              payload.error.trim().length
            ) {
              return payload.error.trim();
            }
            if (
              payload.output &&
              payload.output.answer &&
              typeof payload.output.answer === "string"
            ) {
              return payload.output.answer.trim();
            }
          }
          return status && status >= 500
            ? "The enhancer is unavailable. Please try again shortly."
            : "We could not enhance that prompt. Double-check the text and try once more.";
        };

        const init = () => {
          const elements = Object.freeze({
            form: document.getElementById(enhanceFormId),
            signatureOutput: document.getElementById(signatureOutputId),
            promptOutput: document.getElementById(promptOutputId),
            finalSystemOutput: document.getElementById(
              finalSystemOutputId,
            ),
            finalUserOutput: document.getElementById(finalUserOutputId),
            modelOutput: document.getElementById(modelOutputId),
            status: document.getElementById(statusId),
            error: document.getElementById(errorId),
            submit: document.querySelector(
              `#${enhanceFormId} button[type="submit"]`,
            ),
            feedback: document.getElementById(copyFeedbackId),
            contextSelect: document.getElementById(contextSelectId),
            contextHint: document.getElementById(contextHintId),
            copyButtons: Array.from(
              document.querySelectorAll("button.copy[data-copy-target]"),
            ),
            copyAll: document.getElementById(copyAllId),
            downloadJson: document.getElementById(downloadJsonId),
          });

          if (
            !elements.form || !elements.submit ||
            !elements.signatureOutput ||
            !elements.promptOutput
          ) {
            console.warn(
              "OPE UI: missing required elements. UI will not function.",
            );
            return;
          }

          let state = createState();
          let clearCopyFeedbackTimer = 0;

          const render = (currentState) => {
            const {
              isLoading,
              signatureText,
              enhancedPromptText,
              finalSystemText,
              finalUserText,
              modelOutputText,
              error,
              copyFeedback,
              lastPayload,
            } = currentState;

            if (elements.submit) {
              elements.submit.disabled = isLoading;
              if (isLoading) {
                elements.submit.setAttribute("data-loading", "true");
              } else {
                elements.submit.removeAttribute("data-loading");
              }
            }

            if (elements.status) {
              elements.status.textContent = isLoading
                ? "Enhancing…"
                : "";
              elements.status.hidden = !isLoading;
            }

            if (elements.error) {
              if (error) {
                elements.error.textContent = error;
                elements.error.hidden = false;
              } else {
                elements.error.textContent = "";
                elements.error.hidden = true;
              }
            }

            if (elements.signatureOutput) {
              elements.signatureOutput.value = signatureText;
            }
            if (elements.promptOutput) {
              elements.promptOutput.value = enhancedPromptText;
            }
            if (elements.finalSystemOutput) {
              elements.finalSystemOutput.value = finalSystemText;
            }
            if (elements.finalUserOutput) {
              elements.finalUserOutput.value = finalUserText;
            }
            if (elements.modelOutput) {
              elements.modelOutput.value = modelOutputText;
            }

            for (const btn of elements.copyButtons) {
              const targetId = btn.getAttribute("data-copy-target") || "";
              const targetEl = targetId
                ? document.getElementById(targetId)
                : null;
              const value = targetEl && "value" in targetEl &&
                  typeof targetEl.value === "string"
                ? targetEl.value
                : "";
              btn.disabled = isLoading || !value.trim().length;
            }

            if (elements.copyAll) {
              const hasAnyOutput = [
                signatureText,
                enhancedPromptText,
                finalSystemText,
                finalUserText,
                modelOutputText,
              ].some((t) => typeof t === "string" && t.trim().length);
              elements.copyAll.disabled = isLoading || !hasAnyOutput;
            }

            if (elements.downloadJson) {
              elements.downloadJson.disabled = isLoading || !lastPayload;
            }

            if (elements.feedback) {
              elements.feedback.textContent = copyFeedback;
            }
          };

          const replaceState = (next) => {
            state = createState(next);
            render(state);
            return state;
          };

          const updateState = (transform) =>
            replaceState(transform(state));

          const resetCopyFeedbackLater = () => {
            if (clearCopyFeedbackTimer) {
              window.clearTimeout(clearCopyFeedbackTimer);
            }
            clearCopyFeedbackTimer = window.setTimeout(() => {
              updateState((prev) =>
                mergeState(prev, { copyFeedback: "" })
              );
            }, 2000);
          };

          const isEnhanceForm = (target) => target === elements.form;

          render(state);

          const populateContexts = async () => {
            if (!elements.contextSelect) return;
            try {
              const res = await fetch("/v1/contexts", {
                headers: { accept: "application/json" },
              });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const payload = await res.json();
              const contexts =
                payload && Array.isArray(payload.contexts)
                  ? payload.contexts
                  : [];
              const options = contexts
                .filter((c) =>
                  c && typeof c.id === "string" &&
                  typeof c.name === "string"
                )
                .map((c) => ({
                  id: c.id,
                  name: c.name,
                  description: typeof c.description === "string"
                    ? c.description
                    : "",
                }))
                .sort((a, b) => a.name.localeCompare(b.name));

              for (const ctx of options) {
                const opt = document.createElement("option");
                opt.value = ctx.id;
                opt.textContent = ctx.id;
                opt.title = ctx.description
                  ? `${ctx.name} — ${ctx.description}`
                  : ctx.name;
                elements.contextSelect.appendChild(opt);
              }

              if (elements.contextHint) {
                elements.contextHint.hidden = false;
                elements.contextHint.textContent = options.length
                  ? `Loaded ${options.length} context(s). Hover to preview.`
                  : "No contexts found.";
              }
            } catch (_err) {
              if (elements.contextHint) {
                elements.contextHint.hidden = false;
                elements.contextHint.textContent =
                  "Contexts unavailable (server did not respond).";
              }
            }
          };

          populateContexts();

          const copyToClipboard = async (text) => {
            if (!text || !text.trim().length) return false;
            try {
              await navigator.clipboard.writeText(text);
              return true;
            } catch (_err) {
              try {
                const textarea = document.createElement("textarea");
                textarea.value = text;
                textarea.setAttribute("readonly", "true");
                textarea.style.position = "fixed";
                textarea.style.left = "-9999px";
                document.body.appendChild(textarea);
                textarea.select();
                const ok = document.execCommand("copy");
                document.body.removeChild(textarea);
                return ok;
              } catch (_err2) {
                return false;
              }
            }
          };

          const setCopyFeedback = (message) => {
            updateState((prev) =>
              mergeState(prev, { copyFeedback: message })
            );
            resetCopyFeedbackLater();
          };

          for (const btn of elements.copyButtons) {
            btn.addEventListener("click", async () => {
              const targetId = btn.getAttribute("data-copy-target") || "";
              const targetEl = targetId
                ? document.getElementById(targetId)
                : null;
              const text = targetEl && "value" in targetEl &&
                  typeof targetEl.value === "string"
                ? targetEl.value
                : "";
              const ok = await copyToClipboard(text);
              setCopyFeedback(ok ? "Copied." : "Copy failed.");
            });
          }

          if (elements.copyAll) {
            elements.copyAll.addEventListener("click", async () => {
              const payload = {
                signature: state.signatureText ?? "",
                enhancedPrompt: state.enhancedPromptText ?? "",
                finalSystem: state.finalSystemText ?? "",
                finalUser: state.finalUserText ?? "",
                modelOutput: state.modelOutputText ?? "",
              };
              const ok = await copyToClipboard(
                JSON.stringify(payload, null, 2),
              );
              setCopyFeedback(
                ok ? "Copied all outputs as JSON." : "Copy failed.",
              );
            });
          }

          if (elements.downloadJson) {
            elements.downloadJson.addEventListener("click", () => {
              if (!state.lastPayload) return;
              const blob = new Blob(
                [JSON.stringify(state.lastPayload, null, 2)],
                { type: "application/json" },
              );
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "ope-response.json";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            });
          }

          document.body.addEventListener(
            "htmx:beforeRequest",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              updateState((prev) =>
                mergeState(prev, {
                  isLoading: true,
                  error: null,
                  copyFeedback: "",
                })
              );
            },
          );

          document.body.addEventListener(
            "htmx:afterRequest",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              const { xhr, successful } = event.detail;
              const payload = parseJsonSafe(xhr.responseText);

              if (successful) {
                const signatureText = deriveSignatureText(payload);
                const enhancedPromptText = deriveEnhancedPromptText(
                  payload,
                );
                const finalSystemText = deriveFinalSystemText(payload);
                const finalUserText = deriveFinalUserText(payload);
                const modelOutputText = deriveModelOutputText(payload);
                updateState((prev) =>
                  mergeState(prev, {
                    isLoading: false,
                    signatureText,
                    enhancedPromptText,
                    finalSystemText,
                    finalUserText,
                    modelOutputText,
                    error: null,
                    lastPayload: payload,
                  })
                );
                return;
              }

              updateState((prev) =>
                mergeState(prev, {
                  isLoading: false,
                  error: deriveErrorMessage(payload, xhr.status),
                })
              );
            },
          );

          document.body.addEventListener("htmx:sendError", (event) => {
            if (!isEnhanceForm(event.target)) return;
            updateState((prev) =>
              mergeState(prev, {
                isLoading: false,
                error:
                  "Network error: please check your connection and retry.",
              })
            );
          });

          document.body.addEventListener(
            "htmx:responseError",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              const payload = parseJsonSafe(
                event.detail.xhr.responseText,
              );
              updateState((prev) =>
                mergeState(prev, {
                  isLoading: false,
                  error: deriveErrorMessage(
                    payload,
                    event.detail.xhr.status,
                  ),
                })
              );
            },
          );
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init, {
            once: true,
          });
        } else {
          init();
        }
      })();
    </script>
  </head>
  <body>
    <main>
      <header>
        <div class="brand">
          <h1>Online Prompt Enhancer</h1>
          <p>
            Turn vague prompts into structured, model-ready tasks — and inspect
            every stage of the pipeline.
          </p>
        </div>
      </header>

      <div class="workspace">
      <section class="panel" id="input-panel" aria-labelledby="original-label">
        <div class="panel-head">
          <label id="original-label" for="raw-prompt">Original Prompt</label>
        </div>
        <form
          id="enhance-form"
          hx-post="/v1/generate"
          hx-trigger="submit"
          hx-swap="none"
          hx-ext="json-enc"
        >
          <textarea
            id="raw-prompt"
            class="prompt-input"
            name="rawPrompt"
            required
            placeholder="Paste a prompt. Keep it raw — the enhancer will add structure, constraints, and examples where helpful."
            autocomplete="off"
            spellcheck="true"
          ></textarea>
          <div class="field-grid" aria-label="Advanced options">
            <div>
              <label for="task-type">taskType</label>
              <select id="task-type" name="taskType">
                <option value="">auto</option>
                <option value="qa">qa</option>
                <option value="extract">extract</option>
                <option value="summarize">summarize</option>
              </select>
            </div>
            <div>
              <label for="target-hint">targetHint</label>
              <select id="target-hint" name="targetHint">
                <option value="">auto</option>
                <option value="local">local</option>
                <option value="cloud">cloud</option>
              </select>
            </div>
            <div>
              <label for="context-select">context</label>
              <select id="context-select" name="context">
                <option value="">auto (detect)</option>
              </select>
              <div class="hint" id="context-hint" hidden></div>
            </div>
            <div>
              <label for="enhance-mode">enhance</label>
              <select id="enhance-mode" name="enhance">
                <option value="rules" selected>rules</option>
                <option value="none">none</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit">Enhance Prompt</button>
            <span
              class="status"
              id="status-text"
              hidden
              role="status"
              aria-live="polite"
            >
              Enhancing…
            </span>
          </div>
        </form>
        <div class="error" id="error-message" role="alert" hidden></div>
      </section>

      <section class="panel" id="output-panel" aria-labelledby="enhanced-label">
        <div class="panel-head">
          <label id="enhanced-label">Outputs</label>
          <div class="panel-actions">
            <button
              type="button"
              class="ghost"
              id="download-json"
              disabled
              aria-label="Download full JSON response"
            >
              Download JSON
            </button>
            <button
              type="button"
              class="ghost"
              id="copy-all"
              disabled
              aria-label="Copy all outputs as JSON"
            >
              Copy All
            </button>
          </div>
        </div>

        <div class="output-grid" aria-label="Pipeline outputs">
          <div class="output-card" data-span="2">
            <div class="output-card-head">
              <div class="output-card-title">
                <div class="title">Enhanced Prompt</div>
                <div class="meta">What the model is asked to do (TASK)</div>
              </div>
              <button
                type="button"
                class="copy"
                data-copy-target="enhanced-output"
                aria-label="Copy enhanced prompt"
                disabled
              >
                Copy
              </button>
            </div>
            <textarea
              id="enhanced-output"
              readonly
              placeholder="The enhanced prompt that will be sent to the model will appear here."
            ></textarea>
          </div>

          <div class="output-card">
            <div class="output-card-head">
              <div class="output-card-title">
                <div class="title">Model Output</div>
                <div class="meta">The generated answer (output.answer)</div>
              </div>
              <button
                type="button"
                class="copy"
                data-copy-target="model-output"
                aria-label="Copy model output"
                disabled
              >
                Copy
              </button>
            </div>
            <textarea
              id="model-output"
              readonly
              placeholder="The model's generated answer will appear here."
            ></textarea>
          </div>

          <div class="output-card">
            <div class="output-card-head">
              <div class="output-card-title">
                <div class="title">DSPy Signature</div>
                <div class="meta">IR: role, objective, constraints, steps</div>
              </div>
              <button
                type="button"
                class="copy"
                data-copy-target="signature-output"
                aria-label="Copy DSPy signature"
                disabled
              >
                Copy
              </button>
            </div>
            <textarea
              id="signature-output"
              readonly
              placeholder="The synthesized prompt IR (role, objective, constraints, etc.) will appear here."
            ></textarea>
          </div>

          <div class="output-card">
            <div class="output-card-head">
              <div class="output-card-title">
                <div class="title">Final System Prompt</div>
                <div class="meta">Exact system message sent to the model</div>
              </div>
              <button
                type="button"
                class="copy"
                data-copy-target="final-system-output"
                aria-label="Copy final system prompt"
                disabled
              >
                Copy
              </button>
            </div>
            <textarea
              id="final-system-output"
              readonly
              placeholder="The exact system prompt sent to the model will appear here."
            ></textarea>
          </div>

          <div class="output-card">
            <div class="output-card-head">
              <div class="output-card-title">
                <div class="title">Final User Prompt</div>
                <div class="meta">Exact user message sent to the model</div>
              </div>
              <button
                type="button"
                class="copy"
                data-copy-target="final-user-output"
                aria-label="Copy final user prompt"
                disabled
              >
                Copy
              </button>
            </div>
            <textarea
              id="final-user-output"
              readonly
              placeholder="The exact user prompt sent to the model will appear here."
            ></textarea>
          </div>
        </div>

        <div class="feedback" id="copy-feedback" aria-live="polite"></div>
      </section>
      </div>
    </main>
  </body>
</html>
