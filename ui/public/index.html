<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Online Prompt Enhancer</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f6f6f8;
        --card: #ffffff;
        --border: #d7d7e0;
        --text: #1c1c1f;
        --muted: #5a5a62;
        --accent: #2f6fed;
        --accent-hover: #2154c3;
        --error: #d63d3d;
        --font-body:
          "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        --radius: 16px;
        --shadow: 0 12px 32px rgba(34, 43, 68, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        font-family: var(--font-body);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 16px 12px 24px;
      }

      main {
        width: min(960px, 100%);
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px 18px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      header h1 {
        margin: 0;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      section.panel {
        padding: 18px;
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      label {
        display: block;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 6px;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .label-row label {
        margin: 0;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .field-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (min-width: 920px) {
        .field-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      select,
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        font: inherit;
        font-size: 0.92rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.85);
        color: var(--text);
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.16);
      }

      .hint {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 6px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
        flex-wrap: wrap;
      }

      .tab {
        appearance: none;
        border: 1px solid transparent;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-weight: 500;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition:
          background 120ms ease,
          color 120ms ease,
          border 120ms ease;
      }

      .tab:hover {
        background: rgba(47, 111, 237, 0.08);
        color: var(--text);
      }

      .tab[aria-selected="true"] {
        color: var(--text);
        border-color: rgba(47, 111, 237, 0.35);
        background: rgba(47, 111, 237, 0.12);
      }

      .tab:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.18);
      }

      .tabpanel[hidden] {
        display: none;
      }

      textarea {
        width: 100%;
        min-height: 140px;
        padding: 12px 14px;
        font-family:
          "JetBrains Mono", "SFMono-Regular", ui-monospace, Menlo, Consolas,
          "Liberation Mono", monospace;
        font-size: 0.9rem;
        line-height: 1.45;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        resize: vertical;
        background: rgba(255, 255, 255, 0.8);
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.16);
      }

      textarea[readonly] {
        background: rgba(248, 248, 252, 0.7);
        color: var(--text);
      }

      textarea::placeholder {
        color: rgba(92, 95, 109, 0.68);
      }

      .form-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.01em;
        transition:
          transform 120ms ease,
          box-shadow 120ms ease,
          background 120ms ease;
      }

      button[type="submit"] {
        background: var(--accent);
        color: white;
        box-shadow: 0 10px 24px rgba(47, 111, 237, 0.22);
      }

      button[type="submit"]:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(47, 111, 237, 0.28);
      }

      button[type="submit"][disabled],
      button[type="submit"][data-loading="true"] {
        background: var(--accent-hover);
        opacity: 0.65;
        cursor: progress;
        transform: none;
        box-shadow: none;
      }

      button[type="submit"][data-loading="true"]::after {
        content: "";
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: white;
        margin-left: 12px;
        animation: spinner 700ms linear infinite;
        vertical-align: middle;
      }

      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      button.copy {
        background: rgba(47, 111, 237, 0.1);
        color: var(--accent);
        padding: 0.55rem 1.2rem;
        border-radius: 12px;
        box-shadow: none;
      }

      button.copy:hover {
        background: rgba(47, 111, 237, 0.16);
      }

      button.copy:disabled {
        color: rgba(47, 111, 237, 0.45);
        background: rgba(47, 111, 237, 0.08);
        cursor: not-allowed;
      }

      .status {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .feedback {
        font-size: 0.8rem;
        color: var(--muted);
        min-height: 1em;
      }

      .error {
        background: rgba(214, 61, 61, 0.08);
        border: 1px solid rgba(214, 61, 61, 0.32);
        color: var(--error);
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
      }

      @media (max-width: 720px) {
        header,
        section.panel {
          padding: 16px;
        }

        textarea {
          min-height: 130px;
        }

        .form-actions {
          flex-direction: column;
          align-items: flex-start;
        }

        .form-actions button {
          width: 100%;
          text-align: center;
        }

        .label-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .field-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Keep everything visible (no page scroll) on common short desktop viewports. */
      @media (min-width: 721px) and (max-height: 820px) {
        body {
          height: 100vh;
          overflow: hidden;
          padding-bottom: 16px;
        }

        main {
          height: 100%;
        }

        #input-panel,
        #output-panel {
          flex: 1 1 0;
          overflow: hidden;
        }

        #output-panel {
          flex: 1.25 1 0;
        }

        #enhance-form {
          display: flex;
          flex-direction: column;
          min-height: 0;
          gap: 12px;
        }

        #raw-prompt {
          flex: 1 1 auto;
          min-height: 0;
          resize: none;
        }

        .field-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        /* Tab content stretches to fill remaining height inside the panel. */
        .tabpanel {
          flex: 1 1 auto;
          min-height: 0;
          display: flex;
          flex-direction: column;
        }

        .tabpanel textarea {
          flex: 1 1 auto;
          min-height: 0;
          height: 100%;
          resize: none;
        }

        #panel-final .stack {
          flex: 1 1 auto;
          min-height: 0;
        }

        #panel-final .stack > div {
          flex: 1 1 0;
          min-height: 0;
          display: flex;
          flex-direction: column;
        }

        #error-message {
          max-height: 20vh;
          overflow: auto;
        }
      }

      @media (min-height: 900px) {
        body {
          padding: 32px 16px 64px;
        }

        main {
          gap: 24px;
        }

        header {
          padding: 24px 28px;
        }

        section.panel {
          padding: 28px;
        }

        textarea {
          min-height: 200px;
          padding: 16px 18px;
          font-size: 0.95rem;
          line-height: 1.5;
        }

        button {
          padding: 0.75rem 1.75rem;
          font-size: 0.95rem;
        }

        .status {
          font-size: 0.9rem;
        }

        .feedback {
          font-size: 0.85rem;
        }

        .error {
          padding: 14px 18px;
          font-size: 0.92rem;
        }
      }
    </style>
    <script defer src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script
      defer
      src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"
    ></script>
    <script>
      (() => {
        const enhanceFormId = "enhance-form";
        const promptOutputId = "enhanced-output";
        const signatureOutputId = "signature-output";
        const finalSystemOutputId = "final-system-output";
        const finalUserOutputId = "final-user-output";
        const modelOutputId = "model-output";
        const statusId = "status-text";
        const errorId = "error-message";
        const copyButtonId = "copy-button";
        const copyFeedbackId = "copy-feedback";
        const contextSelectId = "context-select";
        const contextHintId = "context-hint";
        const tabSignatureId = "tab-signature";
        const tabPromptId = "tab-prompt";
        const tabFinalId = "tab-final";
        const tabOutputId = "tab-output";
        const panelSignatureId = "panel-signature";
        const panelPromptId = "panel-prompt";
        const panelFinalId = "panel-final";
        const panelOutputId = "panel-output";

        const createState = (overrides = {}) =>
          Object.freeze({
            isLoading: false,
            activeTab: "prompt",
            signatureText: "",
            enhancedPromptText: "",
            finalSystemText: "",
            finalUserText: "",
            modelOutputText: "",
            error: null,
            copyFeedback: "",
            ...overrides,
          });

        const mergeState = (prev, patch) =>
          createState({ ...prev, ...patch });

        const parseJsonSafe = (raw) => {
          try {
            return raw ? JSON.parse(raw) : null;
          } catch {
            return null;
          }
        };

        const getCompiledPrompts = (payload) => {
          const meta = payload && payload.meta ? payload.meta : null;
          const signature = meta && meta.signature
            ? meta.signature
            : null;
          const compiled = meta && meta.compiled ? meta.compiled : null;
          const source = signature || compiled;
          if (!source) return { system: "", user: "" };
          return {
            system: typeof source.system === "string"
              ? source.system
              : "",
            user: typeof source.user === "string" ? source.user : "",
          };
        };

        const deriveSignatureText = (payload) => {
          // DSPy Signature = IR structure (role, objective, constraints, etc.)
          const ir = payload && payload.meta && payload.meta.ir
            ? payload.meta.ir
            : null;
          if (!ir) return "";

          const lines = [];
          if (ir.role) lines.push(`ROLE: ${ir.role}`);
          if (ir.objective) lines.push(`OBJECTIVE: ${ir.objective}`);
          if (ir.constraints && ir.constraints.length) {
            lines.push(
              `CONSTRAINTS:\n${
                ir.constraints.map((c) => `  • ${c}`).join("\n")
              }`,
            );
          }
          if (ir.style && ir.style.length) {
            lines.push(
              `STYLE:\n${ir.style.map((s) => `  • ${s}`).join("\n")}`,
            );
          }
          if (ir.steps && ir.steps.length) {
            lines.push(
              `STEPS:\n${
                ir.steps.map((s, i) => `  ${i + 1}. ${s}`).join("\n")
              }`,
            );
          }
          if (ir.examples && ir.examples.length) {
            lines.push(
              `EXAMPLES: ${ir.examples.length} few-shot example(s)`,
            );
          }
          if (ir.outputSchema) {
            lines.push(
              `OUTPUT SCHEMA: ${JSON.stringify(ir.outputSchema)}`,
            );
          }
          return lines.join("\n\n");
        };

        const deriveEnhancedPromptText = (payload) => {
          // Enhanced Prompt = the transformed user prompt that will be sent to the model.
          // Prefer extracting the exact prompt used from the compiled user prompt (TASK section),
          // since meta.prompt / meta.enhancement may be display-formatted in demo mode.
          const { user: compiledUser } = getCompiledPrompts(payload);
          if (compiledUser) {
            const taskMatch = compiledUser.match(
              /TASK:\n([\s\S]*?)\n\nOUTPUT:/,
            );
            if (taskMatch && typeof taskMatch[1] === "string") {
              return taskMatch[1];
            }
          }

          const enhanced =
            payload && payload.meta && payload.meta.enhancement &&
              typeof payload.meta.enhancement.enhancedPrompt ===
                "string"
              ? payload.meta.enhancement.enhancedPrompt
              : null;
          if (enhanced && enhanced.length) return enhanced;

          const prompt = payload && payload.meta &&
              typeof payload.meta.prompt === "string"
            ? payload.meta.prompt
            : "";
          return prompt;
        };

        const deriveFinalSystemText = (payload) => {
          return getCompiledPrompts(payload).system;
        };

        const deriveFinalUserText = (payload) => {
          return getCompiledPrompts(payload).user;
        };

        const deriveModelOutputText = (payload) => {
          if (
            payload &&
            payload.output &&
            typeof payload.output.answer === "string"
          ) {
            return payload.output.answer;
          }
          return "";
        };

        const getActiveTabText = (currentState) => {
          if (currentState.activeTab === "signature") {
            return currentState.signatureText;
          }
          if (currentState.activeTab === "prompt") {
            return currentState.enhancedPromptText;
          }
          if (currentState.activeTab === "final") {
            const system = currentState.finalSystemText ?? "";
            const user = currentState.finalUserText ?? "";
            // Copy as a structured payload while preserving exact strings.
            return JSON.stringify(
              {
                messages: [{ role: "system", content: system }, {
                  role: "user",
                  content: user,
                }],
              },
              null,
              2,
            );
          }
          if (currentState.activeTab === "output") {
            return currentState.modelOutputText;
          }
          return "";
        };

        const deriveErrorMessage = (payload, status) => {
          if (payload) {
            if (
              typeof payload.detail === "string" &&
              payload.detail.trim().length
            ) {
              return payload.detail.trim();
            }
            if (
              typeof payload.error === "string" &&
              payload.error.trim().length
            ) {
              return payload.error.trim();
            }
            if (
              payload.output &&
              payload.output.answer &&
              typeof payload.output.answer === "string"
            ) {
              return payload.output.answer.trim();
            }
          }
          return status && status >= 500
            ? "The enhancer is unavailable. Please try again shortly."
            : "We could not enhance that prompt. Double-check the text and try once more.";
        };

        const init = () => {
          const elements = Object.freeze({
            form: document.getElementById(enhanceFormId),
            signatureOutput: document.getElementById(signatureOutputId),
            promptOutput: document.getElementById(promptOutputId),
            finalSystemOutput: document.getElementById(
              finalSystemOutputId,
            ),
            finalUserOutput: document.getElementById(finalUserOutputId),
            modelOutput: document.getElementById(modelOutputId),
            status: document.getElementById(statusId),
            error: document.getElementById(errorId),
            submit: document.querySelector(
              `#${enhanceFormId} button[type="submit"]`,
            ),
            copy: document.getElementById(copyButtonId),
            feedback: document.getElementById(copyFeedbackId),
            contextSelect: document.getElementById(contextSelectId),
            contextHint: document.getElementById(contextHintId),
            tabSignature: document.getElementById(tabSignatureId),
            tabPrompt: document.getElementById(tabPromptId),
            tabFinal: document.getElementById(tabFinalId),
            tabOutput: document.getElementById(tabOutputId),
            panelSignature: document.getElementById(panelSignatureId),
            panelPrompt: document.getElementById(panelPromptId),
            panelFinal: document.getElementById(panelFinalId),
            panelOutput: document.getElementById(panelOutputId),
          });

          if (
            !elements.form || !elements.submit ||
            !elements.signatureOutput ||
            !elements.promptOutput
          ) {
            console.warn(
              "OPE UI: missing required elements. UI will not function.",
            );
            return;
          }

          let state = createState();
          let clearCopyFeedbackTimer = 0;

          const render = (currentState) => {
            const {
              isLoading,
              activeTab,
              signatureText,
              enhancedPromptText,
              finalSystemText,
              finalUserText,
              modelOutputText,
              error,
              copyFeedback,
            } = currentState;

            if (elements.submit) {
              elements.submit.disabled = isLoading;
              if (isLoading) {
                elements.submit.setAttribute("data-loading", "true");
              } else {
                elements.submit.removeAttribute("data-loading");
              }
            }

            if (elements.status) {
              elements.status.textContent = isLoading
                ? "Enhancing…"
                : "";
              elements.status.hidden = !isLoading;
            }

            if (elements.error) {
              if (error) {
                elements.error.textContent = error;
                elements.error.hidden = false;
              } else {
                elements.error.textContent = "";
                elements.error.hidden = true;
              }
            }

            if (elements.signatureOutput) {
              elements.signatureOutput.value = signatureText;
            }
            if (elements.promptOutput) {
              elements.promptOutput.value = enhancedPromptText;
            }
            if (elements.finalSystemOutput) {
              elements.finalSystemOutput.value = finalSystemText;
            }
            if (elements.finalUserOutput) {
              elements.finalUserOutput.value = finalUserText;
            }
            if (elements.modelOutput) {
              elements.modelOutput.value = modelOutputText;
            }

            // Tab visibility logic
            const isSignature = activeTab === "signature";
            const isPrompt = activeTab === "prompt";
            const isFinal = activeTab === "final";
            const isOutput = activeTab === "output";

            if (elements.panelSignature) {
              elements.panelSignature.hidden = !isSignature;
            }
            if (elements.panelPrompt) {
              elements.panelPrompt.hidden = !isPrompt;
            }
            if (elements.panelFinal) {
              elements.panelFinal.hidden = !isFinal;
            }
            if (elements.panelOutput) {
              elements.panelOutput.hidden = !isOutput;
            }

            if (elements.tabSignature) {
              elements.tabSignature.setAttribute(
                "aria-selected",
                isSignature ? "true" : "false",
              );
              elements.tabSignature.tabIndex = isSignature ? 0 : -1;
            }
            if (elements.tabPrompt) {
              elements.tabPrompt.setAttribute(
                "aria-selected",
                isPrompt ? "true" : "false",
              );
              elements.tabPrompt.tabIndex = isPrompt ? 0 : -1;
            }
            if (elements.tabFinal) {
              elements.tabFinal.setAttribute(
                "aria-selected",
                isFinal ? "true" : "false",
              );
              elements.tabFinal.tabIndex = isFinal ? 0 : -1;
            }
            if (elements.tabOutput) {
              elements.tabOutput.setAttribute(
                "aria-selected",
                isOutput ? "true" : "false",
              );
              elements.tabOutput.tabIndex = isOutput ? 0 : -1;
            }

            if (elements.copy) {
              const activeText = getActiveTabText(currentState);
              elements.copy.disabled = !activeText || isLoading;
              const ariaLabels = {
                signature: "Copy prompt IR to clipboard",
                prompt: "Copy enhanced prompt to clipboard",
                final: "Copy final request payload to clipboard",
                output: "Copy model output to clipboard",
              };
              elements.copy.setAttribute(
                "aria-label",
                ariaLabels[activeTab] || ariaLabels.signature,
              );
            }

            if (elements.feedback) {
              elements.feedback.textContent = copyFeedback;
            }
          };

          const replaceState = (next) => {
            state = createState(next);
            render(state);
            return state;
          };

          const updateState = (transform) =>
            replaceState(transform(state));

          const resetCopyFeedbackLater = () => {
            if (clearCopyFeedbackTimer) {
              window.clearTimeout(clearCopyFeedbackTimer);
            }
            clearCopyFeedbackTimer = window.setTimeout(() => {
              updateState((prev) =>
                mergeState(prev, { copyFeedback: "" })
              );
            }, 2000);
          };

          const isEnhanceForm = (target) => target === elements.form;

          render(state);

          const populateContexts = async () => {
            if (!elements.contextSelect) return;
            try {
              const res = await fetch("/v1/contexts", {
                headers: { accept: "application/json" },
              });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const payload = await res.json();
              const contexts =
                payload && Array.isArray(payload.contexts)
                  ? payload.contexts
                  : [];
              const options = contexts
                .filter((c) =>
                  c && typeof c.id === "string" &&
                  typeof c.name === "string"
                )
                .map((c) => ({
                  id: c.id,
                  name: c.name,
                  description: typeof c.description === "string"
                    ? c.description
                    : "",
                }))
                .sort((a, b) => a.name.localeCompare(b.name));

              for (const ctx of options) {
                const opt = document.createElement("option");
                opt.value = ctx.id;
                opt.textContent = ctx.id;
                opt.title = ctx.description
                  ? `${ctx.name} — ${ctx.description}`
                  : ctx.name;
                elements.contextSelect.appendChild(opt);
              }

              if (elements.contextHint) {
                elements.contextHint.hidden = false;
                elements.contextHint.textContent = options.length
                  ? `Loaded ${options.length} context(s). Hover to preview.`
                  : "No contexts found.";
              }
            } catch (_err) {
              if (elements.contextHint) {
                elements.contextHint.hidden = false;
                elements.contextHint.textContent =
                  "Contexts unavailable (server did not respond).";
              }
            }
          };

          populateContexts();

          document.body.addEventListener(
            "htmx:beforeRequest",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              updateState((prev) =>
                mergeState(prev, {
                  isLoading: true,
                  error: null,
                  copyFeedback: "",
                })
              );
            },
          );

          document.body.addEventListener(
            "htmx:afterRequest",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              const { xhr, successful } = event.detail;
              const payload = parseJsonSafe(xhr.responseText);

              if (successful) {
                const signatureText = deriveSignatureText(payload);
                const enhancedPromptText = deriveEnhancedPromptText(
                  payload,
                );
                const finalSystemText = deriveFinalSystemText(payload);
                const finalUserText = deriveFinalUserText(payload);
                const modelOutputText = deriveModelOutputText(payload);
                const shouldAutoSwitch = !!enhancedPromptText;
                updateState((prev) =>
                  mergeState(prev, {
                    isLoading: false,
                    signatureText,
                    enhancedPromptText,
                    finalSystemText,
                    finalUserText,
                    modelOutputText,
                    activeTab:
                      shouldAutoSwitch && prev.activeTab === "signature"
                        ? "prompt"
                        : prev.activeTab,
                    error: null,
                  })
                );
                return;
              }

              updateState((prev) =>
                mergeState(prev, {
                  isLoading: false,
                  error: deriveErrorMessage(payload, xhr.status),
                })
              );
            },
          );

          document.body.addEventListener("htmx:sendError", (event) => {
            if (!isEnhanceForm(event.target)) return;
            updateState((prev) =>
              mergeState(prev, {
                isLoading: false,
                error:
                  "Network error: please check your connection and retry.",
              })
            );
          });

          document.body.addEventListener(
            "htmx:responseError",
            (event) => {
              if (!isEnhanceForm(event.target)) return;
              const payload = parseJsonSafe(
                event.detail.xhr.responseText,
              );
              updateState((prev) =>
                mergeState(prev, {
                  isLoading: false,
                  error: deriveErrorMessage(
                    payload,
                    event.detail.xhr.status,
                  ),
                })
              );
            },
          );

          if (elements.copy) {
            elements.copy.addEventListener("click", async () => {
              const activeText = getActiveTabText(state);
              if (!activeText || state.isLoading) {
                return;
              }
              try {
                await navigator.clipboard.writeText(activeText);
                updateState((prev) =>
                  mergeState(prev, {
                    copyFeedback: "Copied to clipboard.",
                  })
                );
                resetCopyFeedbackLater();
              } catch (_err) {
                updateState((prev) =>
                  mergeState(prev, {
                    error:
                      "Unable to copy to clipboard. Your browser may not allow it.",
                  })
                );
              }
            });
          }

          const setActiveTab = (nextTab) => {
            updateState((prev) => {
              if (
                nextTab !== "signature" && nextTab !== "prompt" &&
                nextTab !== "final" && nextTab !== "output"
              ) return prev;
              return mergeState(prev, { activeTab: nextTab });
            });
          };

          const wireTab = (el, tabValue) => {
            if (!el) return;
            el.addEventListener("click", () => setActiveTab(tabValue));
            el.addEventListener("keydown", (event) => {
              const key = event.key;
              if (
                key !== "ArrowLeft" && key !== "ArrowRight" &&
                key !== "Home" &&
                key !== "End"
              ) return;
              event.preventDefault();
              const order = ["signature", "prompt", "final", "output"];
              const currentIndex = order.indexOf(state.activeTab);
              let nextIndex = currentIndex;
              if (key === "Home") nextIndex = 0;
              if (key === "End") nextIndex = order.length - 1;
              if (key === "ArrowLeft") {
                nextIndex = (currentIndex - 1 + order.length) %
                  order.length;
              }
              if (key === "ArrowRight") {
                nextIndex = (currentIndex + 1) % order.length;
              }
              const next = order[nextIndex];
              setActiveTab(next);
              const tabElements = {
                signature: elements.tabSignature,
                prompt: elements.tabPrompt,
                final: elements.tabFinal,
                output: elements.tabOutput,
              };
              const focusEl = tabElements[next];
              if (focusEl && typeof focusEl.focus === "function") {
                focusEl.focus();
              }
            });
          };

          wireTab(elements.tabSignature, "signature");
          wireTab(elements.tabPrompt, "prompt");
          wireTab(elements.tabFinal, "final");
          wireTab(elements.tabOutput, "output");
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init, {
            once: true,
          });
        } else {
          init();
        }
      })();
    </script>
  </head>
  <body>
    <main>
      <header>
        <h1>Online Prompt Enhancer</h1>
        <p>
          Write your baseline prompt, press enhance, and receive a refined
          version tuned for high-quality model responses.
        </p>
      </header>

      <section class="panel" id="input-panel" aria-labelledby="original-label">
        <label id="original-label" for="raw-prompt">Original Prompt</label>
        <form
          id="enhance-form"
          hx-post="/v1/generate"
          hx-trigger="submit"
          hx-swap="none"
          hx-ext="json-enc"
        >
          <textarea
            id="raw-prompt"
            name="rawPrompt"
            required
            placeholder="Paste the prompt you want to polish. Add goals, constraints, or any relevant context."
            autocomplete="off"
          ></textarea>
          <div class="field-grid" aria-label="Advanced options">
            <div>
              <label for="task-type">taskType</label>
              <select id="task-type" name="taskType">
                <option value="">auto</option>
                <option value="qa">qa</option>
                <option value="extract">extract</option>
                <option value="summarize">summarize</option>
              </select>
            </div>
            <div>
              <label for="target-hint">targetHint</label>
              <select id="target-hint" name="targetHint">
                <option value="">auto</option>
                <option value="local">local</option>
                <option value="cloud">cloud</option>
              </select>
            </div>
            <div>
              <label for="context-select">context</label>
              <select id="context-select" name="context">
                <option value="">auto (detect)</option>
              </select>
              <div class="hint" id="context-hint" hidden></div>
            </div>
            <div>
              <label for="enhance-mode">enhance</label>
              <select id="enhance-mode" name="enhance">
                <option value="rules" selected>rules</option>
                <option value="none">none</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit">Enhance Prompt</button>
            <span
              class="status"
              id="status-text"
              hidden
              role="status"
              aria-live="polite"
            >
              Enhancing…
            </span>
          </div>
        </form>
      </section>

      <section class="panel" id="output-panel" aria-labelledby="enhanced-label">
        <div class="label-row">
          <label id="enhanced-label">Pipeline Output</label>
          <button
            type="button"
            class="copy"
            id="copy-button"
            aria-live="polite"
            aria-label="Copy enhanced prompt to clipboard"
            disabled
          >
            Copy
          </button>
        </div>
        <div class="tabs" role="tablist" aria-label="Pipeline output views">
          <button
            type="button"
            class="tab"
            id="tab-signature"
            role="tab"
            aria-selected="false"
            aria-controls="panel-signature"
            tabindex="-1"
          >
            DSPy Signature
          </button>
          <button
            type="button"
            class="tab"
            id="tab-prompt"
            role="tab"
            aria-selected="true"
            aria-controls="panel-prompt"
          >
            Enhanced Prompt
          </button>
          <button
            type="button"
            class="tab"
            id="tab-final"
            role="tab"
            aria-selected="false"
            aria-controls="panel-final"
            tabindex="-1"
          >
            Final Prompt
          </button>
          <button
            type="button"
            class="tab"
            id="tab-output"
            role="tab"
            aria-selected="false"
            aria-controls="panel-output"
            tabindex="-1"
          >
            Model Output
          </button>
        </div>
        <div
          id="panel-signature"
          class="tabpanel"
          role="tabpanel"
          aria-labelledby="tab-signature"
          hidden
        >
          <textarea
            id="signature-output"
            readonly
            placeholder="The synthesized prompt IR (role, objective, constraints, etc.) will appear here."
          ></textarea>
        </div>
        <div
          id="panel-prompt"
          class="tabpanel"
          role="tabpanel"
          aria-labelledby="tab-prompt"
        >
          <textarea
            id="enhanced-output"
            readonly
            placeholder="The enhanced prompt that will be sent to the model will appear here."
          ></textarea>
        </div>
        <div
          id="panel-final"
          class="tabpanel"
          role="tabpanel"
          aria-labelledby="tab-final"
          hidden
        >
          <div class="stack">
            <div>
              <label for="final-system-output">System Prompt (exact)</label>
              <textarea
                id="final-system-output"
                readonly
                placeholder="The exact system prompt sent to the model will appear here."
              ></textarea>
            </div>
            <div>
              <label for="final-user-output">User Prompt (exact)</label>
              <textarea
                id="final-user-output"
                readonly
                placeholder="The exact user prompt sent to the model will appear here."
              ></textarea>
            </div>
          </div>
        </div>
        <div
          id="panel-output"
          class="tabpanel"
          role="tabpanel"
          aria-labelledby="tab-output"
          hidden
        >
          <textarea
            id="model-output"
            readonly
            placeholder="The model's generated answer will appear here."
          ></textarea>
        </div>
        <div class="feedback" id="copy-feedback" aria-live="polite"></div>
      </section>

      <div class="error" id="error-message" role="alert" hidden></div>
    </main>
  </body>
</html>
