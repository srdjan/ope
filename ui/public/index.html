<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OPE — Online Prompt Enhancer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ═══════════════════════════════════════════════════════════════════════
         CSS Custom Properties & Theme
         ═══════════════════════════════════════════════════════════════════════ */
      :root {
        color-scheme: light dark;

        /* Colors - Light Mode */
        --bg-base: #f8f9fc;
        --bg-elevated: #ffffff;
        --bg-subtle: rgba(0, 0, 0, 0.02);
        --border: rgba(0, 0, 0, 0.08);
        --border-strong: rgba(0, 0, 0, 0.12);
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #94a3b8;
        --accent: #6366f1;
        --accent-hover: #4f46e5;
        --accent-subtle: rgba(99, 102, 241, 0.1);
        --accent-glow: rgba(99, 102, 241, 0.25);
        --success: #10b981;
        --error: #ef4444;
        --glass: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(255, 255, 255, 0.3);

        /* Typography */
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --font-mono: "JetBrains Mono", ui-monospace, "SF Mono", monospace;

        /* Spacing Scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        --space-10: 2.5rem;
        --space-12: 3rem;

        /* Radii */
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        --radius-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.08);
        --shadow-glow: 0 0 40px var(--accent-glow);

        /* Transitions */
        --transition-fast: 120ms ease;
        --transition-base: 200ms ease;
        --transition-slow: 300ms ease;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg-base: #0c0c0f;
          --bg-elevated: #161619;
          --bg-subtle: rgba(255, 255, 255, 0.03);
          --border: rgba(255, 255, 255, 0.08);
          --border-strong: rgba(255, 255, 255, 0.12);
          --text-primary: #f8fafc;
          --text-secondary: #94a3b8;
          --text-muted: #64748b;
          --accent: #818cf8;
          --accent-hover: #a5b4fc;
          --accent-subtle: rgba(129, 140, 248, 0.12);
          --accent-glow: rgba(129, 140, 248, 0.2);
          --glass: rgba(22, 22, 25, 0.8);
          --glass-border: rgba(255, 255, 255, 0.06);
        }
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Reset & Base
         ═══════════════════════════════════════════════════════════════════════ */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        font-size: 16px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        font-family: var(--font-sans);
        background: var(--bg-base);
        color: var(--text-primary);
        line-height: 1.5;
        min-height: 100dvh;
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Layout Structure
         ═══════════════════════════════════════════════════════════════════════ */
      .app {
        display: flex;
        flex-direction: column;
        min-height: 100dvh;
      }

      .app-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        padding: var(--space-4) var(--space-5);
      }

      .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-4);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .brand-logo {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--accent), #a78bfa);
        border-radius: var(--radius-md);
        display: grid;
        place-items: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
      }

      .brand-name {
        font-weight: 700;
        font-size: 1.125rem;
        letter-spacing: -0.02em;
      }

      .brand-tag {
        display: none;
        color: var(--text-muted);
        font-size: 0.8125rem;
      }

      @media (min-width: 640px) {
        .brand-tag {
          display: block;
        }
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Main Content Area
         ═══════════════════════════════════════════════════════════════════════ */
      .app-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1600px;
        width: 100%;
        margin: 0 auto;
        padding: var(--space-4);
        gap: var(--space-4);
      }

      @media (min-width: 1024px) {
        .workspace {
          flex-direction: row;
          padding: var(--space-6);
          gap: var(--space-6);
          height: calc(100dvh - 65px);
        }
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Input Panel
         ═══════════════════════════════════════════════════════════════════════ */
      .input-panel {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      @media (min-width: 1024px) {
        .input-panel {
          width: 420px;
          flex-shrink: 0;
        }
      }

      .card {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }

      .input-card {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      @media (min-width: 1024px) {
        .input-card {
          max-height: calc(100dvh - 65px - var(--space-6) * 2);
        }
      }

      .card-header {
        padding: var(--space-4) var(--space-5);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
      }

      .card-title {
        font-weight: 600;
        font-size: 0.9375rem;
        letter-spacing: -0.01em;
      }

      .card-body {
        padding: var(--space-5);
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Form Elements
         ═══════════════════════════════════════════════════════════════════════ */
      .prompt-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        /* min-height: 180px; */
      }

      @media (min-width: 1024px) {
        .prompt-area {
          min-height: 0;
        }
      }

      .prompt-input {
        flex: 1;
        width: 100%;
        min-height: 60px;
        max-height: 60px;
        padding: var(--space-4);
        font-family: var(--font-sans);
        font-size: 0.9375rem;
        line-height: 1.6;
        color: var(--text-primary);
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        resize: none;
        transition:
          border-color var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .prompt-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-subtle);
      }

      .prompt-input::placeholder {
        color: var(--text-muted);
      }

      /* Settings Dropdown */
      .settings-wrapper {
        position: relative;
      }

      .settings-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        transition:
          border-color var(--transition-fast),
          color var(--transition-fast),
          background var(--transition-fast);
      }

      .settings-btn:hover {
        background: var(--bg-subtle);
        border-color: var(--border-strong);
        color: var(--text-primary);
      }

      .settings-btn[aria-expanded="true"] {
        background: var(--accent-subtle);
        border-color: var(--accent);
        color: var(--accent);
      }

      .settings-btn svg {
        width: 18px;
        height: 18px;
      }

      .settings-dropdown {
        position: absolute;
        top: calc(100% + var(--space-2));
        right: 0;
        width: 280px;
        padding: var(--space-4);
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .settings-dropdown[hidden] {
        display: none;
      }

      .settings-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-bottom: var(--space-2);
        border-bottom: 1px solid var(--border);
      }

      .settings-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
      }

      .field-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-muted);
      }

      .field-select {
        padding: var(--space-2) var(--space-3);
        font-family: var(--font-sans);
        font-size: 0.8125rem;
        color: var(--text-primary);
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          border-color var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .field-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-subtle);
      }

      /* Submit Area */
      .submit-area {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding-top: 15px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-5);
        font-family: var(--font-sans);
        font-size: 0.875rem;
        font-weight: 600;
        line-height: 1;
        border: none;
        border-radius: var(--radius-full);
        cursor: pointer;
        transition:
          transform var(--transition-fast),
          box-shadow var(--transition-fast),
          background var(--transition-fast);
      }

      .btn-primary {
        background: var(--accent);
        color: white;
        box-shadow: var(--shadow-md), 0 0 20px var(--accent-glow);
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg), 0 0 30px var(--accent-glow);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-primary[data-loading="true"] {
        pointer-events: none;
      }

      .btn-primary[data-loading="true"] .btn-text {
        opacity: 0;
      }

      .btn-primary[data-loading="true"]::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .btn-ghost {
        background: transparent;
        color: var(--text-secondary);
        padding: var(--space-2) var(--space-3);
      }

      .btn-ghost:hover {
        background: var(--bg-subtle);
        color: var(--text-primary);
      }

      .btn-ghost:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status-indicator {
        font-size: 0.8125rem;
        color: var(--text-muted);
      }

      .status-indicator[hidden] {
        display: none;
      }

      /* Error Message */
      .error-banner {
        padding: var(--space-3) var(--space-4);
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: var(--radius-md);
        color: var(--error);
        font-size: 0.875rem;
      }

      .error-banner[hidden] {
        display: none;
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Output Panel
         ═══════════════════════════════════════════════════════════════════════ */
      .output-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .output-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 400px;
      }

      @media (min-width: 1024px) {
        .output-card {
          min-height: 0;
          max-height: calc(100dvh - 65px - var(--space-6) * 2);
        }
      }

      /* Tab Navigation */
      .tab-nav {
        display: flex;
        gap: var(--space-1);
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .tab-nav::-webkit-scrollbar {
        display: none;
      }

      .tab-btn {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        font-family: var(--font-sans);
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--text-muted);
        background: transparent;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          color var(--transition-fast),
          background var(--transition-fast);
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: var(--text-secondary);
        background: var(--bg-subtle);
      }

      .tab-btn[aria-selected="true"] {
        color: var(--accent);
        background: var(--accent-subtle);
      }

      .tab-btn .tab-dot {
        width: 6px;
        height: 6px;
        background: var(--text-muted);
        border-radius: 50%;
        opacity: 0;
        transition: opacity var(--transition-fast);
      }

      .tab-btn[data-has-content="true"] .tab-dot {
        opacity: 1;
        background: var(--success);
      }

      /* Tab Content */
      .tab-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .tab-panel {
        flex: 1;
        display: none;
        flex-direction: column;
        min-height: 0;
      }

      .tab-panel[data-active="true"] {
        display: flex;
      }

      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-5);
        border-bottom: 1px solid var(--border);
        background: var(--bg-subtle);
      }

      .output-meta {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
      }

      .output-title {
        font-weight: 600;
        font-size: 0.875rem;
      }

      .output-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .output-body {
        flex: 1;
        padding: var(--space-4);
        min-height: 0;
        overflow: hidden;
      }

      .output-textarea {
        width: 100%;
        height: 100%;
        min-height: 400px;
        padding: var(--space-4);
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        line-height: 1.6;
        color: var(--text-primary);
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        resize: none;
      }

      .output-textarea:focus {
        outline: none;
        border-color: var(--accent);
      }

      .output-textarea::placeholder {
        color: var(--text-muted);
      }

      @media (min-width: 1024px) {
        .output-body {
          padding: var(--space-5);
        }

        .output-textarea {
          min-height: 0;
        }
      }

      /* Output Actions */
      .output-actions {
        display: flex;
        gap: var(--space-2);
      }

      .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        cursor: pointer;
        transition:
          border-color var(--transition-fast),
          color var(--transition-fast);
      }

      .btn-icon:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn-icon:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .btn-icon svg {
        width: 16px;
        height: 16px;
      }

      /* Footer Actions */
      .output-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-5);
        border-top: 1px solid var(--border);
        background: var(--bg-subtle);
      }

      .footer-actions {
        display: flex;
        gap: var(--space-2);
      }

      .copy-feedback {
        font-size: 0.8125rem;
        color: var(--success);
        opacity: 0;
        transition: opacity var(--transition-fast);
      }

      .copy-feedback[data-visible="true"] {
        opacity: 1;
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Toast Notifications
         ═══════════════════════════════════════════════════════════════════════ */
      .toast-container {
        position: fixed;
        bottom: var(--space-6);
        right: var(--space-6);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .toast {
        padding: var(--space-3) var(--space-4);
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        font-size: 0.875rem;
        animation: toast-in 0.3s ease forwards;
      }

      .toast[data-type="success"] {
        border-color: var(--success);
        color: var(--success);
      }

      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Utility Classes
         ═══════════════════════════════════════════════════════════════════════ */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Pipeline Visualization (Desktop)
         ═══════════════════════════════════════════════════════════════════════ */
      .pipeline-indicator {
        display: none;
      }

      @media (min-width: 1024px) {
        .pipeline-indicator {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 48px;
          flex-shrink: 0;
        }

        .pipeline-arrow {
          width: 24px;
          height: 24px;
          color: var(--text-muted);
          opacity: 0.5;
        }

        .pipeline-arrow[data-active="true"] {
          opacity: 1;
          color: var(--accent);
          animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
          0%,
          100% {
            opacity: 0.5;
          }
          50% {
            opacity: 1;
          }
        }
      }

      /* ═══════════════════════════════════════════════════════════════════════
         Keyboard Shortcut Hints
         ═══════════════════════════════════════════════════════════════════════ */
      .kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        padding: 2px 6px;
        font-family: var(--font-sans);
        font-size: 0.6875rem;
        font-weight: 500;
        color: var(--text-muted);
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        border-radius: 4px;
      }

      .shortcut-hint {
        display: none;
        align-items: center;
        gap: var(--space-1);
        margin-left: var(--space-2);
      }

      @media (min-width: 768px) {
        .shortcut-hint {
          display: inline-flex;
        }
      }
    </style>
    <script defer src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script
      defer
      src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"
    ></script>
    <script>
      (() => {
        // ─────────────────────────────────────────────────────────────────────
        // State Management
        // ─────────────────────────────────────────────────────────────────────
        const createState = (overrides = {}) =>
          Object.freeze({
            isLoading: false,
            activeTab: "enhanced",
            outputs: {
              enhanced: "",
              model: "",
              signature: "",
              system: "",
              user: "",
            },
            error: null,
            copyFeedback: "",
            lastPayload: null,
            settingsOpen: false,
            ...overrides,
          });

        let state = createState();
        let feedbackTimer = 0;

        // ─────────────────────────────────────────────────────────────────────
        // DOM References
        // ─────────────────────────────────────────────────────────────────────
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));

        // ─────────────────────────────────────────────────────────────────────
        // Data Extraction Helpers
        // ─────────────────────────────────────────────────────────────────────
        const parseJson = (str) => {
          try {
            return str ? JSON.parse(str) : null;
          } catch {
            return null;
          }
        };

        const getCompiledPrompts = (payload) => {
          const meta = payload?.meta;
          const source = meta?.signature || meta?.compiled;
          return {
            system: source?.system || "",
            user: source?.user || "",
          };
        };

        const extractEnhancedPrompt = (payload) => {
          const { user } = getCompiledPrompts(payload);
          const match = user.match(/TASK:\n([\s\S]*?)\n\nOUTPUT:/);
          if (match?.[1]) return match[1];
          return (
            payload?.meta?.enhancement?.enhancedPrompt ||
            payload?.meta?.prompt ||
            ""
          );
        };

        const extractSignature = (payload) => {
          const ir = payload?.meta?.ir;
          if (!ir) return "";
          const lines = [];
          if (ir.role) lines.push(`ROLE: ${ir.role}`);
          if (ir.objective) lines.push(`OBJECTIVE: ${ir.objective}`);
          if (ir.constraints?.length)
            lines.push(
              `CONSTRAINTS:\n${ir.constraints.map((c) => `  • ${c}`).join("\n")}`,
            );
          if (ir.style?.length)
            lines.push(`STYLE:\n${ir.style.map((s) => `  • ${s}`).join("\n")}`);
          if (ir.steps?.length)
            lines.push(
              `STEPS:\n${ir.steps.map((s, i) => `  ${i + 1}. ${s}`).join("\n")}`,
            );
          if (ir.examples?.length)
            lines.push(`EXAMPLES: ${ir.examples.length} few-shot example(s)`);
          if (ir.outputSchema)
            lines.push(`OUTPUT SCHEMA: ${JSON.stringify(ir.outputSchema)}`);
          return lines.join("\n\n");
        };

        const extractModelOutput = (payload) => payload?.output?.answer || "";

        const extractError = (payload, status) => {
          if (payload?.detail?.trim()) return payload.detail.trim();
          if (payload?.error?.trim()) return payload.error.trim();
          return status >= 500
            ? "Service unavailable. Please try again."
            : "Could not enhance prompt. Check your input.";
        };

        // ─────────────────────────────────────────────────────────────────────
        // Render Functions
        // ─────────────────────────────────────────────────────────────────────
        const render = () => {
          const submitBtn = $("#submit-btn");
          const statusEl = $("#status-indicator");
          const errorEl = $("#error-banner");
          const pipelineArrow = $(".pipeline-arrow");
          const feedbackEl = $(".copy-feedback");

          // Submit button state
          if (submitBtn) {
            submitBtn.disabled = state.isLoading;
            submitBtn.setAttribute(
              "data-loading",
              state.isLoading ? "true" : "false",
            );
          }

          // Status indicator
          if (statusEl) {
            statusEl.hidden = !state.isLoading;
            statusEl.textContent = state.isLoading ? "Enhancing…" : "";
          }

          // Pipeline arrow
          if (pipelineArrow) {
            pipelineArrow.setAttribute(
              "data-active",
              state.isLoading ? "true" : "false",
            );
          }

          // Error display
          if (errorEl) {
            errorEl.hidden = !state.error;
            errorEl.textContent = state.error || "";
          }

          // Tab buttons - show content indicator
          $$(".tab-btn").forEach((btn) => {
            const tabId = btn.dataset.tab;
            const hasContent = !!(state.outputs[tabId] || "").trim();
            btn.setAttribute("data-has-content", hasContent ? "true" : "false");
            btn.setAttribute(
              "aria-selected",
              state.activeTab === tabId ? "true" : "false",
            );
          });

          // Tab panels
          $$(".tab-panel").forEach((panel) => {
            const isActive = panel.dataset.tab === state.activeTab;
            panel.setAttribute("data-active", isActive ? "true" : "false");
          });

          // Output textareas
          Object.entries(state.outputs).forEach(([key, value]) => {
            const textarea = $(`#output-${key}`);
            if (textarea) textarea.value = value;
          });

          // Copy buttons
          $$(".btn-copy").forEach((btn) => {
            const targetId = btn.dataset.copyTarget;
            const value = state.outputs[targetId] || "";
            btn.disabled = state.isLoading || !value.trim();
          });

          // Copy all / download buttons
          const hasAnyOutput = Object.values(state.outputs).some((v) =>
            v.trim(),
          );
          const copyAllBtn = $("#copy-all-btn");
          const downloadBtn = $("#download-btn");
          if (copyAllBtn) copyAllBtn.disabled = state.isLoading || !hasAnyOutput;
          if (downloadBtn)
            downloadBtn.disabled = state.isLoading || !state.lastPayload;

          // Copy feedback
          if (feedbackEl) {
            feedbackEl.setAttribute(
              "data-visible",
              state.copyFeedback ? "true" : "false",
            );
            feedbackEl.textContent = state.copyFeedback;
          }

          // Settings dropdown
          const settingsBtn = $("#settings-btn");
          const settingsDropdown = $("#settings-dropdown");
          if (settingsBtn) {
            settingsBtn.setAttribute(
              "aria-expanded",
              state.settingsOpen ? "true" : "false",
            );
          }
          if (settingsDropdown) {
            settingsDropdown.hidden = !state.settingsOpen;
          }
        };

        const updateState = (patch) => {
          state = createState({ ...state, ...patch });
          render();
        };

        // ─────────────────────────────────────────────────────────────────────
        // Clipboard & Feedback
        // ─────────────────────────────────────────────────────────────────────
        const copyToClipboard = async (text) => {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch {
            return false;
          }
        };

        const showFeedback = (msg) => {
          clearTimeout(feedbackTimer);
          updateState({ copyFeedback: msg });
          feedbackTimer = setTimeout(() => updateState({ copyFeedback: "" }), 2000);
        };

        // ─────────────────────────────────────────────────────────────────────
        // Event Handlers
        // ─────────────────────────────────────────────────────────────────────
        const handleTabClick = (e) => {
          const btn = e.target.closest(".tab-btn");
          if (!btn) return;
          updateState({ activeTab: btn.dataset.tab });
        };

        const handleCopyClick = async (e) => {
          const btn = e.target.closest(".btn-copy");
          if (!btn) return;
          const targetId = btn.dataset.copyTarget;
          const text = state.outputs[targetId] || "";
          const ok = await copyToClipboard(text);
          showFeedback(ok ? "Copied!" : "Copy failed");
        };

        const handleCopyAll = async () => {
          const payload = JSON.stringify(state.outputs, null, 2);
          const ok = await copyToClipboard(payload);
          showFeedback(ok ? "All outputs copied!" : "Copy failed");
        };

        const handleDownload = () => {
          if (!state.lastPayload) return;
          const blob = new Blob([JSON.stringify(state.lastPayload, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "ope-response.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        const handleSettingsToggle = (e) => {
          e.stopPropagation();
          updateState({ settingsOpen: !state.settingsOpen });
        };

        const handleClickOutside = (e) => {
          if (!state.settingsOpen) return;
          const wrapper = $(".settings-wrapper");
          if (wrapper && !wrapper.contains(e.target)) {
            updateState({ settingsOpen: false });
          }
        };

        const handleEscKey = (e) => {
          if (e.key === "Escape" && state.settingsOpen) {
            updateState({ settingsOpen: false });
          }
        };

        // ─────────────────────────────────────────────────────────────────────
        // HTMX Event Handlers
        // ─────────────────────────────────────────────────────────────────────
        const setupHtmxHandlers = () => {
          const form = $("#enhance-form");
          if (!form) return;

          document.body.addEventListener("htmx:beforeRequest", (e) => {
            if (e.target !== form) return;
            updateState({ isLoading: true, error: null, copyFeedback: "" });
          });

          document.body.addEventListener("htmx:afterRequest", (e) => {
            if (e.target !== form) return;
            const { xhr, successful } = e.detail;
            const payload = parseJson(xhr.responseText);

            if (successful) {
              const { system, user } = getCompiledPrompts(payload);
              updateState({
                isLoading: false,
                outputs: {
                  enhanced: extractEnhancedPrompt(payload),
                  model: extractModelOutput(payload),
                  signature: extractSignature(payload),
                  system,
                  user,
                },
                lastPayload: payload,
                error: null,
              });
              return;
            }

            updateState({
              isLoading: false,
              error: extractError(payload, xhr.status),
            });
          });

          document.body.addEventListener("htmx:sendError", (e) => {
            if (e.target !== form) return;
            updateState({
              isLoading: false,
              error: "Network error. Check your connection.",
            });
          });
        };

        // ─────────────────────────────────────────────────────────────────────
        // Context Loading
        // ─────────────────────────────────────────────────────────────────────
        const loadContexts = async () => {
          const select = $("#context-select");
          if (!select) return;

          try {
            const res = await fetch("/v1/contexts", {
              headers: { accept: "application/json" },
            });
            if (!res.ok) return;
            const data = await res.json();
            const contexts = data?.contexts || [];

            contexts
              .filter((c) => c?.id && c?.name)
              .sort((a, b) => a.name.localeCompare(b.name))
              .forEach((ctx) => {
                const opt = document.createElement("option");
                opt.value = ctx.id;
                opt.textContent = ctx.id;
                opt.title = ctx.description
                  ? `${ctx.name} — ${ctx.description}`
                  : ctx.name;
                select.appendChild(opt);
              });
          } catch {
            // Silently fail - contexts are optional
          }
        };

        // ─────────────────────────────────────────────────────────────────────
        // Keyboard Shortcuts
        // ─────────────────────────────────────────────────────────────────────
        const setupKeyboardShortcuts = () => {
          document.addEventListener("keydown", (e) => {
            // Cmd/Ctrl + Enter to submit
            if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
              const form = $("#enhance-form");
              if (form && !state.isLoading) {
                e.preventDefault();
                form.requestSubmit();
              }
            }

            // Number keys 1-5 to switch tabs (when not in input)
            if (
              !e.metaKey &&
              !e.ctrlKey &&
              !e.altKey &&
              document.activeElement?.tagName !== "TEXTAREA" &&
              document.activeElement?.tagName !== "INPUT"
            ) {
              const tabs = ["enhanced", "model", "signature", "system", "user"];
              const num = parseInt(e.key);
              if (num >= 1 && num <= 5) {
                e.preventDefault();
                updateState({ activeTab: tabs[num - 1] });
              }
            }
          });
        };

        // ─────────────────────────────────────────────────────────────────────
        // Initialization
        // ─────────────────────────────────────────────────────────────────────
        const init = () => {
          render();
          setupHtmxHandlers();
          loadContexts();
          setupKeyboardShortcuts();

          // Tab navigation
          $(".tab-nav")?.addEventListener("click", handleTabClick);

          // Copy buttons
          document.addEventListener("click", handleCopyClick);

          // Copy all
          $("#copy-all-btn")?.addEventListener("click", handleCopyAll);

          // Download
          $("#download-btn")?.addEventListener("click", handleDownload);

          // Settings dropdown
          $("#settings-btn")?.addEventListener("click", handleSettingsToggle);
          document.addEventListener("click", handleClickOutside);
          document.addEventListener("keydown", handleEscKey);
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init, { once: true });
        } else {
          init();
        }
      })();
    </script>
  </head>
  <body>
    <div class="app">
      <!-- Header -->
      <header class="app-header">
        <div class="header-content">
          <div class="brand">
            <div class="brand-logo">OPE</div>
            <span class="brand-name">Online Prompt Enhancer</span>
            <span class="brand-tag">Transform prompts into structured tasks</span>
          </div>
          <div class="header-actions">
            <button
              type="button"
              class="btn btn-ghost"
              id="download-btn"
              disabled
              aria-label="Download JSON response"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              <span>JSON</span>
            </button>
            <div class="settings-wrapper">
              <button
                type="button"
                class="settings-btn"
                id="settings-btn"
                aria-expanded="false"
                aria-controls="settings-dropdown"
                aria-label="Settings"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="3" />
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
              </button>
              <div class="settings-dropdown" id="settings-dropdown" hidden>
                <div class="settings-title">Settings</div>
                <div class="settings-grid">
                  <div class="field">
                    <label class="field-label" for="task-type">Task Type</label>
                    <select class="field-select" id="task-type" name="taskType" form="enhance-form">
                      <option value="">auto</option>
                      <option value="qa">qa</option>
                      <option value="extract">extract</option>
                      <option value="summarize">summarize</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="field-label" for="target-hint">Target</label>
                    <select class="field-select" id="target-hint" name="targetHint" form="enhance-form">
                      <option value="">auto</option>
                      <option value="local">local</option>
                      <option value="cloud">cloud</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="field-label" for="context-select">Context</label>
                    <select class="field-select" id="context-select" name="context" form="enhance-form">
                      <option value="">auto</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="field-label" for="enhance-mode">Enhance</label>
                    <select class="field-select" id="enhance-mode" name="enhance" form="enhance-form">
                      <option value="rules" selected>rules</option>
                      <option value="none">none</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="app-main">
        <div class="workspace">
          <!-- Input Panel -->
          <section class="input-panel">
            <div class="card input-card">
              <div class="card-header">
                <h2 class="card-title">Input Prompt</h2>
              </div>
              <div class="card-body">
                <form
                  id="enhance-form"
                  hx-post="/v1/generate"
                  hx-trigger="submit"
                  hx-swap="none"
                  hx-ext="json-enc"
                >
                  <div class="prompt-area">
                    <textarea
                      id="raw-prompt"
                      class="prompt-input"
                      name="rawPrompt"
                      required
                      placeholder="Enter your prompt here. Keep it raw — OPE will add structure, constraints, and examples."
                      autocomplete="off"
                      spellcheck="true"
                    ></textarea>
                  </div>

                  <div class="submit-area">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                      <span class="btn-text">Enhance</span>
                      <span class="shortcut-hint">
                        <span class="kbd">⌘</span>
                        <span class="kbd">↵</span>
                      </span>
                    </button>
                    <span
                      class="status-indicator"
                      id="status-indicator"
                      role="status"
                      aria-live="polite"
                      hidden
                    ></span>
                  </div>
                </form>

                <div class="error-banner" id="error-banner" role="alert" hidden></div>
              </div>
            </div>
          </section>

          <!-- Pipeline Arrow (Desktop) -->
          <div class="pipeline-indicator">
            <svg
              class="pipeline-arrow"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="5" y1="12" x2="19" y2="12" />
              <polyline points="12 5 19 12 12 19" />
            </svg>
          </div>

          <!-- Output Panel -->
          <section class="output-panel">
            <div class="card output-card">
              <!-- Tab Navigation -->
              <nav class="tab-nav" role="tablist">
                <button
                  class="tab-btn"
                  role="tab"
                  data-tab="enhanced"
                  aria-selected="true"
                  aria-controls="panel-enhanced"
                >
                  <span class="tab-dot"></span>
                  Enhanced
                </button>
                <button
                  class="tab-btn"
                  role="tab"
                  data-tab="model"
                  aria-selected="false"
                  aria-controls="panel-model"
                >
                  <span class="tab-dot"></span>
                  Model Output
                </button>
                <button
                  class="tab-btn"
                  role="tab"
                  data-tab="signature"
                  aria-selected="false"
                  aria-controls="panel-signature"
                >
                  <span class="tab-dot"></span>
                  Signature
                </button>
                <button
                  class="tab-btn"
                  role="tab"
                  data-tab="system"
                  aria-selected="false"
                  aria-controls="panel-system"
                >
                  <span class="tab-dot"></span>
                  System
                </button>
                <button
                  class="tab-btn"
                  role="tab"
                  data-tab="user"
                  aria-selected="false"
                  aria-controls="panel-user"
                >
                  <span class="tab-dot"></span>
                  User
                </button>
              </nav>

              <!-- Tab Content -->
              <div class="tab-content">
                <!-- Enhanced Prompt Tab -->
                <div
                  class="tab-panel"
                  id="panel-enhanced"
                  data-tab="enhanced"
                  data-active="true"
                  role="tabpanel"
                >
                  <div class="output-header">
                    <div class="output-meta">
                      <div class="output-title">Enhanced Prompt</div>
                      <div class="output-desc">The task sent to the model</div>
                    </div>
                    <div class="output-actions">
                      <button
                        type="button"
                        class="btn-icon btn-copy"
                        data-copy-target="enhanced"
                        aria-label="Copy enhanced prompt"
                        disabled
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="output-body">
                    <textarea
                      id="output-enhanced"
                      class="output-textarea"
                      readonly
                      placeholder="Enhanced prompt will appear here…"
                    ></textarea>
                  </div>
                </div>

                <!-- Model Output Tab -->
                <div
                  class="tab-panel"
                  id="panel-model"
                  data-tab="model"
                  data-active="false"
                  role="tabpanel"
                >
                  <div class="output-header">
                    <div class="output-meta">
                      <div class="output-title">Model Output</div>
                      <div class="output-desc">Generated response (output.answer)</div>
                    </div>
                    <div class="output-actions">
                      <button
                        type="button"
                        class="btn-icon btn-copy"
                        data-copy-target="model"
                        aria-label="Copy model output"
                        disabled
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="output-body">
                    <textarea
                      id="output-model"
                      class="output-textarea"
                      readonly
                      placeholder="Model's answer will appear here…"
                    ></textarea>
                  </div>
                </div>

                <!-- Signature Tab -->
                <div
                  class="tab-panel"
                  id="panel-signature"
                  data-tab="signature"
                  data-active="false"
                  role="tabpanel"
                >
                  <div class="output-header">
                    <div class="output-meta">
                      <div class="output-title">DSPy Signature</div>
                      <div class="output-desc">IR: role, objective, constraints, steps</div>
                    </div>
                    <div class="output-actions">
                      <button
                        type="button"
                        class="btn-icon btn-copy"
                        data-copy-target="signature"
                        aria-label="Copy signature"
                        disabled
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="output-body">
                    <textarea
                      id="output-signature"
                      class="output-textarea"
                      readonly
                      placeholder="Synthesized IR structure will appear here…"
                    ></textarea>
                  </div>
                </div>

                <!-- System Prompt Tab -->
                <div
                  class="tab-panel"
                  id="panel-system"
                  data-tab="system"
                  data-active="false"
                  role="tabpanel"
                >
                  <div class="output-header">
                    <div class="output-meta">
                      <div class="output-title">System Prompt</div>
                      <div class="output-desc">Exact system message sent to model</div>
                    </div>
                    <div class="output-actions">
                      <button
                        type="button"
                        class="btn-icon btn-copy"
                        data-copy-target="system"
                        aria-label="Copy system prompt"
                        disabled
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="output-body">
                    <textarea
                      id="output-system"
                      class="output-textarea"
                      readonly
                      placeholder="System prompt will appear here…"
                    ></textarea>
                  </div>
                </div>

                <!-- User Prompt Tab -->
                <div
                  class="tab-panel"
                  id="panel-user"
                  data-tab="user"
                  data-active="false"
                  role="tabpanel"
                >
                  <div class="output-header">
                    <div class="output-meta">
                      <div class="output-title">User Prompt</div>
                      <div class="output-desc">Exact user message sent to model</div>
                    </div>
                    <div class="output-actions">
                      <button
                        type="button"
                        class="btn-icon btn-copy"
                        data-copy-target="user"
                        aria-label="Copy user prompt"
                        disabled
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="output-body">
                    <textarea
                      id="output-user"
                      class="output-textarea"
                      readonly
                      placeholder="User prompt will appear here…"
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- Footer -->
              <div class="output-footer">
                <span class="copy-feedback" aria-live="polite"></span>
                <div class="footer-actions">
                  <button
                    type="button"
                    class="btn btn-ghost"
                    id="copy-all-btn"
                    disabled
                  >
                    Copy All
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </body>
</html>
